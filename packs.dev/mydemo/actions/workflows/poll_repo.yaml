version: 1.0

description: poll remote repo

input:
  - working_dir
  - branch
  - expected
  - timeout

output:
  - failed: <% ctx().failed %>
  - action_name: <% ctx().action_name %>
  - action_result: <% ctx().action_result %>
  

tasks:
  init:
    action: core.noop
    next:
    - publish:
        - failed: False
        - action_name: poll_repo
      do: git_status
  
  git_status:
    action: mydemo.git_status
    input:
      working_dir: /usr/src/app/flask-docker
      branch: devel-views
      expected: not_up_to_date
      timeout: 300
    next:
      - when: <% succeeded() and (ctx().expected = 'not_up_to_date') %>
        do: git_merge
      - when: <% succeeded() and (ctx().expected = 'up_to_date') %>
        do: post_msg
        publish:
          - action_result: |-
             [failed_task]
             none, completed git_status after git_merge 
             <% result() %>
      - when: <% failed() and ctx().expected = "not_up_to_date" %>
        do: git_status_on_failure
        publish:
          - failed: True
          - rc_on_failure: <% result().return_code %>
      - when: <% failed() and ctx().expected = "up_to_date" %>
        do: git_status_on_failure
        publish:
          - failed: True
          - rc_on_failure: <% result().return_code %>
      
  git_merge:
    action: core.local
    input:
      cmd: sudo git merge origin/<% ctx().branch %>
      cwd: <% ctx().working_dir %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() %>
        do: git_status
        publish:
          - expected: "up_to_date"
      - when: <% failed() %>
        do: post_msg
        publish:
          - action_result: |-
              [failed_task]
              git merge
              [the previous]
              git_status
              <% result() %>
  
  git_status_on_failure:
    action: core.noop
    next:
      - do: post_msg
        publish:
          - action_result: |-
              [failed_task]
              git_status
              [the previous]
              init
              <% result() %>
              [rc_on_failure]
              <% ctx().rc_on_failure %>
  
  post_msg:
    action: slack.post_message
    input:
      message: |-
        [action_name] 
        <% ctx().action_name %>
        [failed]
        <% ctx().failed %>
        [action_result]
        <% ctx().action_result %>
    next:
      - do: last
  
  last:
    action: core.noop
    next:
      - when: <% ctx().failed %>
        do: fail
  