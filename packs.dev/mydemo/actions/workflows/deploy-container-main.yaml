version: 1.0

description: deploy-container-main

input:
  - containers_name
  - working_dir
  - rebuilding_timeout

vars:
  - stdout: null
  - stderr: null

tasks:
  stop_rm_container:
    with: <% ctx(containers_name) %>
    action: core.local
    input: 
      cmd: >
        for i in $(docker container ls | grep -E '<% item() %>.*Up' | awk '{print $1}'); do 
        docker container stop $i && docker container rm $i; done
    next:
      - when: <% succeeded() %>
        do: rebuild_container
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
  
  rebuild_container:
    action: core.local 
    input:
      cmd: sudo docker-compose up -d --build
      cwd: <% ctx().working_dir %> 
      timeout: <% ctx().rebuilding_timeout %> 
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>

output:
  - stdout: <% ctx().stdout %>
  - stderr: <% ctx().stderr %>