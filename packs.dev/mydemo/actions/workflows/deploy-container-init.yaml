version: 1.0

description: deploy-container-init

input:
  - working_dir
  - branch

vars:
  - msg: null

tasks:
  git_fetch:
    action: mydemo.git_fetch
    input:
      branch: <% ctx().branch %>
      cwd: <% ctx().working_dir %>
    next:
      - when: <% succeeded() %>
        do: git_merge
        publish: 
          - msg: <% result() %>
      - when: <% failed() %>
        do: fail
        publish: 
          - msg: <% result() %>
  
  git_merge:
    action: core.local
    input:
      cmd: >
        sudo git checkout <% ctx().branch %> && 
        sudo git merge origin/<% ctx().branch %>
      cwd: <% ctx().working_dir %>
    next:
      - when: <% succeeded() %>
        publish:
          - msg: <% result() %>
      - when: <% failed() %>
        do: fail
        publish: 
          - msg: <% result() %>

output:
  - msg: <% ctx().msg %>
