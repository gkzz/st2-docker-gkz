version: 1.0

description: deploy-container-init

input:
  - working_dir
  - branch
  - filters

tasks:
  git_fetch:
    action: core.local 
    input:
      cmd: sudo git fetch
      cwd: <% ctx().working_dir %>
    next:
      - when: <% succeeded() %>
        do: git_checkout
        publish: 
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        publish: 
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>

  git_checkout:
    action: core.local
    input:
      cmd: sudo git checkout <% ctx().branch %>
      cwd: <% ctx().working_dir %>
    next:
      - when: <% succeeded() %>
        do: git_status
      - when: <% failed() %>
        publish: 
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
  
  git_status:
    action: core.local
    input:
      cmd: sudo git status
      cwd: <% ctx().working_dir %>
    next:
      - when: <% succeeded() %>
        do: validate
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        publish: 
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
  
  validate:
    action: mydemo.validate
    input:
      filters: <% ctx().filters %>
      stdout: <% ctx().stdout %>
    next:
      - when: <% succeeded() %>
        do: git_merge
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        publish: 
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
  
  git_merge:
    action: core.local
    input:
      cmd: sudo git merge origin/<% ctx().branch %>
      cwd: <% ctx().working_dir %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        publish: 
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>

output:
  - stdout: <% ctx().stdout %>
  - stderr: <% ctx().stderr %>
