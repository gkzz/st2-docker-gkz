version: 1.0

description: deploy-container-overview

input:
  - working_dir
  - branch
  - containers_name
  - rebuilding_timeout

tasks:
  init:
    action: mydemo.deploy-container-init
    input:
      working_dir: <% ctx().working_dir %>
      branch: <% ctx().branch %>
    next:
      - when: <% succeeded() and (result().output.output != 'Already up-to-date.') %>
        do: main
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().output.stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        do: last
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
  
  main:
    action: mydemo.deploy-container-main
    input:
      containers_name:  <% ctx().containers_name %>
      working_dir:  <% ctx().working_dir %>
      rebuilding_timeout:  <% ctx().rebuilding_timeout %>
    next:
      - when: <% succeeded() %>
        do: last
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        do: last
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>

  last:
    action: slack.post_message
    input:
      message: <% ctx().msg %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>

output:
  - stdout: <% ctx().stdout %>
  - stderr: <% ctx().stderr %>