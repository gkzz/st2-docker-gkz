version: 1.0

description: deploy-container-overview

input:
  - main_action_name
  - working_dir
  - branch
  - ptn
  - timeout

vars:
  - failed:
  - msg: 
  - return_value: 


output:
  - main_action_name: <% ctx().main_action_name %>
  - failed: <% ctx().failed %>

  

tasks:
  git_pull:
    action: mydemo.git_pull
    input:
      working_dir: <% ctx().working_dir %>
      branch: <% ctx().branch %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() %>
        do: after_git_pull
        publish:
          - return_value: <% result().return_value %>
      - when: <% failed() %>
        do: post_msg
        publish:
          - failed: True
          - return_value: <% result().return_value %>

  after_git_pull:
    action: core.noop
    next:
      - when: <% ctx().return_value != null %>
        do: rebuild
      - when: <% ctx().return_value = null %>
        do: post_msg
        publish:
          - failed: False
          - msg: "[git_pull] null"
      
  rebuild:
    action: mydemo.rebuild
    input:
      working_dir: <% ctx().working_dir %>
      ptn: <% ctx().ptn %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() %>
        do: after_rebuild
        publish:
          - return_value: <% result().return_value %>
      - when: <% failed() %>
        do: post_msg
        publish:
          - failed: True
          - msg: <% result().return_value %>
        
  after_rebuild:
    action: core.noop
    next:
      - when: <% ctx().return_value != null %>
        do: post_msg
        publish:
          - failed: False
          - msg: <% result() %>
      - when: <% ctx().eturn_value = null %>
        do: post_msg
        publish:
          - failed: True
          - msg: <% result() %>

  post_msg:
    action: slack.post_message
    input:
      message: |-
        <% ctx().main_action_name %>
        <% ctx().failed %>
        <% ctx().msg %>
    next:
      - when: <% succeeded() or failed() %>
        do: last
  
  last:
    action: core.noop
    next:
      - when: <% ctx().failed %>
        do: fail
