version: 1.0

description: deploy-container-overview

input:
  - working_dir
  - branch
  - ptn
  - timeout

vars:
  - stdout: 
  - stderr: 
  - failed: 

output:
  - stdout: <% ctx().stdout %>
  - stderr: <% ctx().stderr %>

  

tasks:
  git_pull:
    action: mydemo.git_pull
    input:
      working_dir: <% ctx().working_dir %>
      branch: <% ctx().branch %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() %>
        do: after_git_pull
        publish:
          - stdout: <% result().stdout %>
      - when: <% failed() %>
        do: last
        publish:
          - failed: True
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>

  after_git_pull:
    action: core.noop
    next:
      - when: <% ctx().stdout != null %>
        do: rebuild
      - when: <% ctx().stdout = null %>
        do: last
        publish:
          - failed: False
          - stdout: "[git_pull] None"
          - stderr: "None"
      
  rebuild:
    action: mydemo.rebuild
    input:
      working_dir: <% ctx().working_dir %>
      ptn: <% ctx().ptn %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() %>
        do: after_rebuild
        publish:
          - stdout: <% result().stdout %>
      - when: <% failed() %>
        do: last
        publish:
          - failed: True
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
        
  after_rebuild:
    action: core.noop
    next:
      - when: <% ctx().stdout != null %>
        do: last
        publish:
          - failed: False
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% ctx().stdout = null %>
        do: last
        publish:
          - failed: True
          - stdout: |-
              "##### Unknown Error May Occur To You ########
              [rebuild] None"
          - stderr: "None"

  last:
    action: slack.post_message
    input:
      message: |-
         [failed] <% ctx().failed %>
         [stdout] <% ctx().stdout %>
         [stderr] <% ctx().stderr %>
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
      - when: <% failed() %>
        do: fail
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
