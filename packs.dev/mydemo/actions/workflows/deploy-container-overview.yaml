version: 1.0

description: deploy-container-overview

input:
  - working_dir
  - branch
  - containers_name
  - timeout
  - output

vars:
  - msg: null

tasks:
  git_pull:
    action: mydemo.git_pull
    input:
      working_dir: <% ctx().working_dir %>
      branch: <% ctx().branch %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() and result().output != null %>
        do: rebuild
        publish:
          - msg: <% result() %>
      - when: <% succeeded() and result().output = null %>
        do: last
        publish:
          - msg: <% result() %>
      - when: <% failed() %>
        do: fail
        publish:
          - msg: <% result() %>
  rebuild:
    action: mydemo.rebuild
    input:
      working_dir: <% ctx().working_dir %>
      ptn: <% ctx().ptn %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() and result().output != null %>
        do: last
        publish:
          - msg: |-
              [sudo docker-compose up -d --build]
              <% result() %>
      - when: <% succeeded() and result().output = null %>
        do: last
        publish:
          - msg: |-
              [sudo docker-compose up -d --build] None
              <% result() %>
      - when: <% failed() %>
        do: fail
        publish:
          - msg: |-
              [docker container stop/rm]
              <% result() %>
  last:
    action: slack.post_message
    input:
      message: <% ctx().msg %>
    next:
      - when: <% succeeded() %>
        publish:
          - msg: <% result() %>
      - when: <% failed() %>
        do: fail
        publish:
          - msg: <% result() %>

output:
  - msg: <% ctx().msg %>