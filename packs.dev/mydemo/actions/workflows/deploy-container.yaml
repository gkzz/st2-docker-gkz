version: 1.0

description: deploy-container

input:
  - containers_name
  - working_dir

tasks:
  stop_rm_container:
    with: <% ctx(containers_name) %>
    action: >
      core.local cmd="for i in ${docker container ls | grep -E "flask-docker_<% item() %>.*Up" | awk '{print $1}'}; do 
                      cd <% ctx().working_dir %> && 
                      docker container stop $i && docker container rm $i; done"
    next:
      - when: <% succeeded() %>
        do: rebuild_container
      - when: <% failed() %>
        publish: msg=<% result() %>
        do: post-on-slack
  
  rebuild_container:
    action: >
      core.local cmd="cd <% ctx().working_dir %> && 
                      docker-compose up -d --build"
    input: working_dir
    next:
      - when: <% succeeded() %>
        publish: msg=<% result() %>
        do: post-on-slack
      - when: <% failed() %>
        publish: msg=<% result() %>
        do: post_on_slack
  
  post_on_slack:
    action: slack.post_message
    input:
      message: <% ctx(msg) %>