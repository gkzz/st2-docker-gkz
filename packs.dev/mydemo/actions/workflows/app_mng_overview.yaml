version: 1.0

description: poll remote repo

input:
  - working_dir
  - branch
  - expectedst2 run mydemo.app_mng_overview
  - timeout

output:
  - failed: <% ctx().failed %>
  - action_name: <% ctx().action_name %>
  - action_result: <% ctx().action_result %>
  

tasks:
  init:
    action: core.noop
    next:
    - publish:
        - failed: False
      do: poll_repo
  
  poll_repo:
    action: mydemo.poll_repo
    input:
      working_dir: <% ctx().working_dir %>
      branch: <% ctx().branch %>
      expected: <% ctx().expected %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() %>
        do: rebuild_app
      - when: <% failed() %>
        do: last
        publish:
          - failed: True
  
  rebuild_app:
    action: mydemo.rebuild_app
    input:
      working_dir: <% ctx().working_dir %>
      ptn: <% ctx().ptn %>
      timeout: <% ctx().timeout %>
    next:
      - when: <% succeeded() %>
        do: last
      - when: <% failed() %>
        do: last
        publish:
          - failed: True
  
  last:
    action: core.noop
    next:
      - when: <% ctx().failed %>
        do: fail